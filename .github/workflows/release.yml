name: Build Installers

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev libxkbcommon-dev
      
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
      
      - name: Build
        run: cargo build --release --features full
      
      - name: Install cargo-deb
        run: cargo install cargo-deb
      
      - name: Build DEB package
        run: cargo deb
      
      - name: Create portable tarball
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          DIST_DIR="a2rs-${VERSION}-linux-x86_64"
          mkdir -p "$DIST_DIR"/{roms,disks,saves,screenshots}
          cp target/release/a2rs "$DIST_DIR/"
          cp README.md "$DIST_DIR/"
          echo '{"speed":1,"fast_disk":true,"sound_enabled":true,"rom_dir":"roms","disk_dir":"disks","screenshot_dir":"screenshots","save_dir":"saves"}' > "$DIST_DIR/apple2_config.json"
          tar -czvf "a2rs-${VERSION}-linux-x86_64.tar.gz" "$DIST_DIR"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            target/debian/*.deb
            a2rs-*-linux-x86_64.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
      
      - name: Build
        run: cargo build --release --features full
      
      - name: Create .app bundle
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          APP_DIR="A2RS.app/Contents"
          mkdir -p "$APP_DIR/MacOS"
          mkdir -p "$APP_DIR/Resources"/{roms,disks,saves,screenshots}
          cp target/release/a2rs "$APP_DIR/MacOS/"
          cat > "$APP_DIR/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key><string>A2RS</string>
              <key>CFBundleVersion</key><string>${VERSION}</string>
              <key>CFBundleExecutable</key><string>a2rs</string>
              <key>CFBundlePackageType</key><string>APPL</string>
              <key>NSHighResolutionCapable</key><true/>
          </dict>
          </plist>
          EOF
      
      - name: Create DMG
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          mkdir dmg_contents
          cp -r A2RS.app dmg_contents/
          ln -s /Applications dmg_contents/Applications
          hdiutil create -volname "A2RS" -srcfolder dmg_contents -ov -format UDZO "A2RS-${VERSION}-macos.dmg"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-packages
          path: A2RS-*-macos.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
      
      - name: Build
        run: cargo build --release --features full
      
      - name: Create portable ZIP
        shell: pwsh
        run: |
          $version = (Select-String -Path Cargo.toml -Pattern '^version' | Select-Object -First 1).Line -replace '.*"(.*)".*', '$1'
          $distDir = "a2rs-$version-windows-x64"
          New-Item -ItemType Directory -Force -Path "$distDir/roms", "$distDir/disks", "$distDir/saves", "$distDir/screenshots"
          Copy-Item "target/release/a2rs.exe" "$distDir/"
          Copy-Item "README.md" "$distDir/" -ErrorAction SilentlyContinue
          '{"speed":1,"fast_disk":true,"sound_enabled":true,"rom_dir":"roms","disk_dir":"disks","screenshot_dir":"screenshots","save_dir":"saves"}' | Out-File "$distDir/apple2_config.json" -Encoding utf8
          Compress-Archive -Path $distDir -DestinationPath "a2rs-$version-windows-x64.zip"
      
      - name: Install cargo-wix
        run: cargo install cargo-wix
      
      - name: Build MSI
        run: |
          cargo wix init
          cargo wix
        continue-on-error: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-packages
          path: |
            a2rs-*-windows-x64.zip
            target/wix/*.msi

  release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-packages/*
            macos-packages/*
            windows-packages/*
          draft: true
          generate_release_notes: true
